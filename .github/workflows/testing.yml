name: testing

on:
 push:
   branches:
     - main
     - 'version-**'
   tags: ["*"]
 pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  build-test-cmake:
    name: CMake

    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest', 'macos-latest', 'windows-2022']

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v6
      with:
        # required for `git describe --tags` to work
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: 3.14 
        cache: 'pip'

    - name: Install Conan
      uses: conan-io/setup-conan@v1
      with:
        cache_packages: true

    - name: Install dependencies
      shell: bash
      run: |
        python3 -m pip install -r requirements.txt
        mkdir cmake-build
        conan install . --output-folder=cmake-build --build=missing

    - name: Build (Unix)
      if: runner.os != 'Windows'
      run: |
        cmake --preset conan-release -DBUILD_TESTS=ON -DENABLE_ASAN=ON -DENABLE_UBSAN=ON -DRST_DOC=ON
        cmake --build --preset conan-release

    - name: Build (Windows)
      if: runner.os == 'Windows'
      run: |
        cmake --preset conan-default
        cmake --build --preset conan-release -DRST_DOC=ON

    - name: Run tests
      run: |
        ctest --preset conan-release
      env:
        RD_SKIP_SIGNAL: 1
        ERT_SHOW_BACKTRACE: 1

  build-test-wheel:
    name: Python ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest', 'macos-latest', 'windows-2022']

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python[0] }}

    - name: Build wheels
      uses: pypa/cibuildwheel@v3.3.1
      with:
        extras: "uv"

    - name: Upload wheels
      uses: actions/upload-artifact@v6
      with:
        name: wheels-${{ matrix.os }}
        path: wheelhouse/*.whl

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-test-wheel]

    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')

    steps:
      - name: Get wheels
        uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
        with:
          password: ${{ secrets.PYPI_TOKEN_RESDATA }}
          skip-existing: true
